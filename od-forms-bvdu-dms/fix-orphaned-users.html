<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Fix Orphaned Users - BVDU</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #000000 0%, #0a0a0a 100%);
      color: white;
      min-height: 100vh;
      padding: 2rem;
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 1rem;
      padding: 2rem;
    }

    h1 {
      font-size: 2rem;
      margin-bottom: 1rem;
      background: linear-gradient(135deg, #3b82f6 0%, #60a5fa 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .info {
      background: rgba(59, 130, 246, 0.1);
      border: 1px solid rgba(59, 130, 246, 0.3);
      border-radius: 0.5rem;
      padding: 1rem;
      margin-bottom: 1.5rem;
      color: rgba(255, 255, 255, 0.8);
    }

    .form-group {
      margin-bottom: 1.5rem;
    }

    label {
      display: block;
      margin-bottom: 0.5rem;
      color: rgba(255, 255, 255, 0.9);
      font-weight: 600;
    }

    input, select {
      width: 100%;
      padding: 0.75rem;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 0.5rem;
      color: white;
      font-size: 1rem;
    }

    input:focus, select:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
    }

    button {
      width: 100%;
      padding: 1rem;
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
      border: none;
      border-radius: 0.5rem;
      color: white;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }

    button:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 10px 30px rgba(59, 130, 246, 0.4);
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .status {
      margin-top: 1rem;
      padding: 1rem;
      border-radius: 0.5rem;
    }

    .status.success {
      background: rgba(34, 197, 94, 0.1);
      border: 1px solid rgba(34, 197, 94, 0.3);
      color: #86efac;
    }

    .status.error {
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid rgba(239, 68, 68, 0.3);
      color: #fca5a5;
    }

    .status.info {
      background: rgba(59, 130, 246, 0.1);
      border: 1px solid rgba(59, 130, 246, 0.3);
      color: #93c5fd;
    }

    code {
      background: rgba(0, 0, 0, 0.3);
      padding: 0.2rem 0.4rem;
      border-radius: 0.25rem;
      font-family: monospace;
    }

    .back-link {
      display: inline-block;
      margin-top: 1rem;
      color: #60a5fa;
      text-decoration: none;
    }

    .back-link:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üîß Fix Orphaned User</h1>
    
    <div class="info">
      <strong>What this does:</strong><br>
      If a user was created in Supabase Auth but not in the database (orphaned user), this tool will create their database record.
    </div>

    <form id="fixForm" onsubmit="fixOrphanedUser(event)">
      <div class="form-group">
        <label>Email (the one showing the error)</label>
        <input type="email" id="email" placeholder="surveyvinit5006@gmail.com" required>
      </div>

      <div class="form-group">
        <label>Password (their current password)</label>
        <input type="password" id="password" required>
      </div>

      <div class="form-group">
        <label>Full Name</label>
        <input type="text" id="fullName" placeholder="Vinit Sandip Surve" required>
      </div>

      <div class="form-group">
        <label>First Name</label>
        <input type="text" id="firstName" placeholder="Vinit" required>
      </div>

      <div class="form-group">
        <label>Middle Name</label>
        <input type="text" id="middleName" placeholder="Sandip" required>
      </div>

      <div class="form-group">
        <label>Surname</label>
        <input type="text" id="surname" placeholder="Surve" required>
      </div>

      <div class="form-group">
        <label>PRN</label>
        <input type="text" id="prn" placeholder="2347100255" required>
      </div>

      <div class="form-group">
        <label>Phone</label>
        <input type="tel" id="phone" placeholder="9876543210">
      </div>

      <div class="form-group">
        <label>Course</label>
        <select id="course" required>
          <option value="">Select Course</option>
          <option value="BBA">BBA</option>
          <option value="BCA">BCA</option>
          <option value="BAF">BAF</option>
          <option value="MBA">MBA</option>
        </select>
      </div>

      <div class="form-group">
        <label>Year</label>
        <select id="year" required>
          <option value="">Select Year</option>
          <option value="1">First Year</option>
          <option value="2">Second Year</option>
          <option value="3">Third Year</option>
        </select>
      </div>

      <div class="form-group">
        <label>Division</label>
        <input type="text" id="division" placeholder="A" required>
      </div>

      <div class="form-group">
        <label>Roll Number</label>
        <input type="text" id="rollNumber" placeholder="01" required>
      </div>

      <button type="submit" id="submitBtn">Fix User Record</button>
    </form>

    <div id="status"></div>

    <a href="index.html" class="back-link">‚Üê Back to Home</a>
  </div>

  <script>
    const SUPABASE_URL = 'https://nzkwqsbigkyvaxazfwgu.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im56a3dxc2JpZ2t5dmF4YXpmd2d1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ3OTg4NTgsImV4cCI6MjA4MDM3NDg1OH0.ZYyF95McgS3McU8zr7K3L2HHXkEHR1Acd0AmoTu5wL4';

    const { createClient } = supabase;
    const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    function showStatus(message, type = 'info') {
      const statusDiv = document.getElementById('status');
      statusDiv.className = `status ${type}`;
      statusDiv.innerHTML = message;
    }

    async function fixOrphanedUser(event) {
      event.preventDefault();
      
      const btn = document.getElementById('submitBtn');
      btn.disabled = true;
      btn.textContent = 'Fixing...';

      try {
        // Get form values
        const email = document.getElementById('email').value.trim();
        const password = document.getElementById('password').value;
        const fullName = document.getElementById('fullName').value.trim();
        const firstName = document.getElementById('firstName').value.trim();
        const middleName = document.getElementById('middleName').value.trim();
        const surname = document.getElementById('surname').value.trim();
        const prn = document.getElementById('prn').value.trim();
        const phone = document.getElementById('phone').value.trim();
        const course = document.getElementById('course').value;
        const year = document.getElementById('year').value;
        const division = document.getElementById('division').value.trim();
        const rollNumber = document.getElementById('rollNumber').value.trim();

        showStatus('Step 1: Signing in to verify credentials...', 'info');

        // Sign in to verify credentials and get user ID
        const { data: signInData, error: signInError } = await supabaseClient.auth.signInWithPassword({
          email: email,
          password: password
        });

        if (signInError) {
          throw new Error(`Login failed: ${signInError.message}`);
        }

        const userId = signInData.user.id;
        showStatus(`Step 2: Found auth user with ID: ${userId}<br>Creating database record...`, 'info');

        // Check if user already exists in database
        const { data: existingUser } = await supabaseClient
          .from('users')
          .select('id')
          .eq('id', userId)
          .single();

        if (existingUser) {
          showStatus(
            `‚úÖ User already has a database record!<br>` +
            `You can now <a href="login.html" style="color: #60a5fa;">login here</a>`,
            'success'
          );
          btn.textContent = 'Already Fixed';
          return;
        }

        // Calculate dates from PRN
        const yearPrefix = parseInt(prn.substring(0, 2));
        const admissionYear = 2000 + yearPrefix;
        const admissionDate = new Date(admissionYear, 6, 15);
        const expectedGraduationDate = new Date(admissionYear + (course === 'MBA' ? 2 : 3), 5, 30);

        // Create user record
        const userData = {
          id: userId,
          email: email,
          role: 'student',
          full_name: fullName,
          first_name: firstName,
          middle_name: middleName,
          surname: surname,
          phone: phone,
          prn: prn,
          course: course,
          year: year,
          division: division,
          roll_number: rollNumber,
          profile_photo_url: null,
          admission_date: admissionDate.toISOString().split('T')[0],
          admission_month: 7,
          expected_graduation_date: expectedGraduationDate.toISOString().split('T')[0],
          is_active: true
        };

        console.log('Creating user with data:', userData);

        const { data: createdUser, error: createError } = await supabaseClient
          .from('users')
          .insert(userData)
          .select()
          .single();

        if (createError) {
          console.error('Create error:', createError);
          throw new Error(`Database error: ${createError.message}`);
        }

        console.log('User created:', createdUser);

        showStatus(
          `‚úÖ User record fixed successfully!<br><br>` +
          `<strong>Details:</strong><br>` +
          `Email: ${email}<br>` +
          `User ID: ${userId}<br>` +
          `PRN: ${prn}<br><br>` +
          `You can now <a href="login.html" style="color: #60a5fa;">login here</a>`,
          'success'
        );

        btn.textContent = '‚úì Fixed Successfully';
        document.getElementById('fixForm').reset();

        // Auto-redirect after 3 seconds
        setTimeout(() => {
          window.location.href = 'login.html';
        }, 3000);

      } catch (error) {
        console.error('Fix error:', error);
        showStatus(
          `‚ùå Failed to fix user record<br><br>` +
          `Error: ${error.message}<br><br>` +
          `Please contact support with this error message.`,
          'error'
        );
        btn.disabled = false;
        btn.textContent = 'Try Again';
      }
    }
  </script>
</body>
</html>
