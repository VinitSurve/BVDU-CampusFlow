<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Review OD Form - Faculty - BVDU CampusFlow</title>
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=Space+Grotesk:wght@500;600;700;800&display=swap" rel="stylesheet">
  
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', sans-serif;
      background: #0A0E27;
      color: #E2E8F0;
      min-height: 100vh;
    }

    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: radial-gradient(circle at 20% 30%, rgba(66, 133, 244, 0.08), transparent 50%),
                  radial-gradient(circle at 80% 70%, rgba(52, 168, 83, 0.08), transparent 50%);
      z-index: 0;
      pointer-events: none;
    }

    body::after {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-image: 
        linear-gradient(rgba(255, 255, 255, 0.02) 1px, transparent 1px),
        linear-gradient(90deg, rgba(255, 255, 255, 0.02) 1px, transparent 1px);
      background-size: 50px 50px;
      z-index: 0;
      pointer-events: none;
    }

    .container {
      position: relative;
      z-index: 1;
    }

    .navbar {
      position: sticky;
      top: 0;
      z-index: 100;
      background: rgba(10, 14, 39, 0.9);
      backdrop-filter: blur(20px);
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .navbar-brand {
      font-family: 'Space Grotesk', sans-serif;
      font-size: 1.5rem;
      font-weight: 700;
      background: linear-gradient(135deg, #4285F4 0%, #34A853 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .nav-link {
      color: #94A3B8;
      padding: 0.5rem 1rem;
      border-radius: 0.5rem;
      transition: all 0.3s ease;
      font-weight: 500;
      text-decoration: none;
    }

    .nav-link:hover {
      color: #4285F4;
      background: rgba(66, 133, 244, 0.1);
    }

    .review-container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 2rem 1.5rem 4rem;
    }

    .page-header {
      margin-bottom: 2.5rem;
      padding: 3rem;
      background: linear-gradient(135deg, rgba(66, 133, 244, 0.1) 0%, rgba(52, 168, 83, 0.1) 100%);
      border: 1px solid rgba(66, 133, 244, 0.2);
      border-radius: 24px;
    }

    .page-title {
      font-family: 'Space Grotesk', sans-serif;
      font-size: 2.5rem;
      font-weight: 800;
      background: linear-gradient(135deg, #4285F4 0%, #34A853 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 1.5rem;
    }

    .form-meta {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1.5rem;
      margin-top: 1.5rem;
    }

    .meta-item {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 16px;
      padding: 1.25rem;
    }

    .meta-label {
      font-size: 0.875rem;
      color: #94A3B8;
      margin-bottom: 0.5rem;
    }

    .meta-value {
      font-size: 1.125rem;
      color: #E2E8F0;
      font-weight: 600;
    }

    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 1.25rem;
      border-radius: 2rem;
      font-size: 0.875rem;
      font-weight: 700;
      text-transform: uppercase;
    }

    .status-pending {
      background: rgba(251, 191, 36, 0.2);
      color: #FCD34D;
      border: 1px solid rgba(251, 191, 36, 0.3);
    }

    .info-card {
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 20px;
      padding: 2rem;
      margin-bottom: 1.5rem;
    }

    .info-card h2 {
      font-family: 'Space Grotesk', sans-serif;
      font-size: 1.5rem;
      font-weight: 700;
      color: #4285F4;
      margin-bottom: 1.5rem;
    }

    .info-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 1.5rem;
    }

    .info-item {
      background: rgba(255, 255, 255, 0.02);
      border: 1px solid rgba(255, 255, 255, 0.05);
      border-radius: 12px;
      padding: 1rem;
    }

    .info-item label {
      font-size: 0.875rem;
      color: #94A3B8;
      margin-bottom: 0.5rem;
      display: block;
    }

    .info-item value {
      font-size: 1rem;
      color: #E2E8F0;
      font-weight: 600;
    }

    .subjects-table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0 0.5rem;
    }

    .subjects-table th {
      background: rgba(66, 133, 244, 0.1);
      color: #4285F4;
      padding: 1rem;
      text-align: left;
      font-weight: 600;
      font-size: 0.875rem;
      text-transform: uppercase;
    }

    .subjects-table th:first-child {
      border-radius: 12px 0 0 12px;
    }

    .subjects-table th:last-child {
      border-radius: 0 12px 12px 0;
    }

    .subjects-table td {
      background: rgba(255, 255, 255, 0.03);
      padding: 1.25rem 1rem;
      border-top: 1px solid rgba(255, 255, 255, 0.05);
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }

    .subjects-table td:first-child {
      border-left: 1px solid rgba(255, 255, 255, 0.05);
      border-radius: 12px 0 0 12px;
    }

    .subjects-table td:last-child {
      border-right: 1px solid rgba(255, 255, 255, 0.05);
      border-radius: 0 12px 12px 0;
    }

    .subjects-table tbody tr.approved {
      background: rgba(52, 168, 83, 0.1);
    }

    .subjects-table tbody tr.rejected {
      background: rgba(239, 68, 68, 0.1);
    }

    .subject-actions {
      display: flex;
      gap: 0.5rem;
    }

    .btn-subject {
      padding: 0.5rem 1rem;
      border-radius: 8px;
      font-size: 0.875rem;
      font-weight: 600;
      cursor: pointer;
      border: 2px solid;
      transition: all 0.3s ease;
    }

    .btn-subject-approve {
      background: rgba(52, 168, 83, 0.1);
      color: #34A853;
      border-color: rgba(52, 168, 83, 0.3);
    }

    .btn-subject-approve:hover {
      background: rgba(52, 168, 83, 0.2);
    }

    .btn-subject-approve.active {
      background: #34A853;
      color: white;
    }

    .btn-subject-reject {
      background: rgba(239, 68, 68, 0.1);
      color: #EF4444;
      border-color: rgba(239, 68, 68, 0.3);
    }

    .btn-subject-reject:hover {
      background: rgba(239, 68, 68, 0.2);
    }

    .btn-subject-reject.active {
      background: #EF4444;
      color: white;
    }

    .approval-summary {
      display: flex;
      gap: 2rem;
      justify-content: center;
      padding: 2rem;
      background: rgba(255, 255, 255, 0.03);
      border-radius: 16px;
      margin: 2rem 0;
    }

    .summary-item {
      text-align: center;
    }

    .summary-number {
      font-size: 3rem;
      font-weight: 800;
      font-family: 'Space Grotesk', sans-serif;
    }

    .summary-label {
      font-size: 0.875rem;
      color: #94A3B8;
      margin-top: 0.5rem;
    }

    .summary-approved .summary-number {
      color: #34A853;
    }

    .summary-rejected .summary-number {
      color: #EF4444;
    }

    .summary-pending .summary-number {
      color: #FBCF33;
    }

    .approval-section {
      background: linear-gradient(135deg, rgba(66, 133, 244, 0.05) 0%, rgba(52, 168, 83, 0.05) 100%);
      border: 1px solid rgba(66, 133, 244, 0.2);
      border-radius: 20px;
      padding: 2.5rem;
      margin-top: 2rem;
    }

    .approval-section h2 {
      font-family: 'Space Grotesk', sans-serif;
      font-size: 1.75rem;
      font-weight: 700;
      color: #34A853;
      margin-bottom: 1.5rem;
    }

    .comments-box {
      width: 100%;
      min-height: 120px;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      padding: 1rem;
      color: #E2E8F0;
      font-family: 'Inter', sans-serif;
      resize: vertical;
    }

    .comments-box:focus {
      outline: none;
      border-color: #4285F4;
    }

    .approval-buttons {
      display: flex;
      gap: 1rem;
      margin-top: 2rem;
      flex-wrap: wrap;
    }

    .btn {
      padding: 1rem 2rem;
      border-radius: 12px;
      font-weight: 600;
      cursor: pointer;
      border: none;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .btn-approve {
      background: linear-gradient(135deg, #34A853 0%, #0F9D58 100%);
      color: white;
      flex: 1;
    }

    .btn-approve:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(52, 168, 83, 0.3);
    }

    .btn-reject {
      background: linear-gradient(135deg, #EA4335 0%, #D33B2C 100%);
      color: white;
      flex: 1;
    }

    .btn-reject:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(234, 67, 53, 0.3);
    }

    .btn-submit {
      background: linear-gradient(135deg, #FBBC04 0%, #F9AB00 100%);
      color: #0A0E27;
      font-weight: 700;
      flex: 2;
    }

    .btn-submit:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(251, 188, 4, 0.3);
    }

    .btn-back {
      background: rgba(255, 255, 255, 0.1);
      color: #94A3B8;
    }

    .btn-back:hover {
      background: rgba(255, 255, 255, 0.15);
      color: #E2E8F0;
    }

    .loading {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 60vh;
    }

    .loading-spinner {
      width: 48px;
      height: 48px;
      border: 4px solid rgba(66, 133, 244, 0.2);
      border-top-color: #4285F4;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .document-link {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.75rem 1.25rem;
      background: rgba(66, 133, 244, 0.1);
      border: 1px solid rgba(66, 133, 244, 0.3);
      border-radius: 12px;
      color: #4285F4;
      text-decoration: none;
      transition: all 0.3s ease;
    }

    .document-link:hover {
      background: rgba(66, 133, 244, 0.2);
      transform: translateY(-2px);
    }
  </style>
</head>
<body>
  <nav class="navbar">
    <div class="container mx-auto px-6 py-4">
      <div class="flex items-center justify-between">
        <a href="dashboard.html" class="navbar-brand">üéì BVDU CampusFlow</a>
        <div class="flex items-center gap-4">
          <a href="dashboard.html" class="nav-link">Dashboard</a>
          <a href="od-forms.html" class="nav-link">OD Forms</a>
          <button onclick="logout()" class="nav-link">Logout</button>
        </div>
      </div>
    </div>
  </nav>

  <div class="review-container container">
    <div class="loading" id="loading">
      <div class="loading-spinner"></div>
      <p style="margin-top: 1rem; color: #94A3B8;">Loading form details...</p>
    </div>

    <div id="formContent" style="display: none;">
      <div class="page-header">
        <div class="page-title">üìã Faculty Review - OD Form</div>
        <div class="form-meta" id="formMeta"></div>
      </div>

      <div class="info-card">
        <h2>üìö Student Information</h2>
        <div class="info-grid" id="studentInfo"></div>
      </div>

      <div class="info-card">
        <h2>üìÖ Event Details</h2>
        <div class="info-grid" id="eventInfo"></div>
      </div>

      <div class="info-card">
        <h2>‚úÖ Event Leader Approval</h2>
        <div id="leaderApprovalStatus"></div>
      </div>

      <div class="info-card">
        <h2>üìñ Missed Lectures</h2>
        <div class="approval-summary" id="approvalSummary">
          <div class="summary-item summary-approved">
            <div class="summary-number" id="approvedCount">0</div>
            <div class="summary-label">Approved</div>
          </div>
          <div class="summary-item summary-rejected">
            <div class="summary-number" id="rejectedCount">0</div>
            <div class="summary-label">Rejected</div>
          </div>
          <div class="summary-item summary-pending">
            <div class="summary-number" id="pendingCount">0</div>
            <div class="summary-label">Pending</div>
          </div>
        </div>
        <div style="overflow-x: auto;">
          <table class="subjects-table" id="subjectsTable"></table>
        </div>
      </div>

      <div class="info-card" id="proofDocumentsCard">
        <h2>üìé Proof Documents</h2>
        <div id="proofDocuments"></div>
      </div>

      <div class="approval-section">
        <h2>‚úÖ Faculty Approval</h2>
        <label style="color: #94A3B8; font-size: 0.875rem; margin-bottom: 0.75rem; display: block;">
          Comments / Remarks (Optional)
        </label>
        <textarea id="comments" class="comments-box" placeholder="Add any comments, remarks, or notes about this OD form..."></textarea>
        
        <div class="approval-buttons">
          <button onclick="goBack()" class="btn btn-back">‚Üê BACK</button>
          <button onclick="rejectAll()" class="btn btn-reject">‚úï REJECT ALL</button>
          <button onclick="approveAll()" class="btn btn-approve">‚úì APPROVE ALL</button>
          <button onclick="submitDecisions()" class="btn btn-submit">üöÄ SUBMIT DECISIONS</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    const supabaseClient = window.supabase.createClient(
      'https://uhvtmwoihzaaqawimdhm.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVodnRtd29paHphYXFhd2ltZGhtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg4MzI2NTgsImV4cCI6MjA4NDQwODY1OH0.-bvdcoPnpT0k8po4gLF-UOXaNTLSb666i1ReGoTAj0Y'
    );

    let currentForm = null;
    let currentUser = null;
    let subjectApprovals = {};

    async function init() {
      try {
        const { data: { session } } = await supabaseClient.auth.getSession();
        if (!session) {
          window.location.href = '../../login.html';
          return;
        }

        const { data: user } = await supabaseClient
          .from('users')
          .select('*')
          .eq('id', session.user.id)
          .single();

        if (!user || !['faculty', 'hod', 'admin'].includes(user.role)) {
          alert('Access denied. Faculty/HOD/Admin only.');
          window.location.href = './dashboard.html';
          return;
        }

        currentUser = user;

        const urlParams = new URLSearchParams(window.location.search);
        const formId = urlParams.get('id');

        if (!formId) {
          alert('No form ID provided');
          window.location.href = './od-forms.html';
          return;
        }

        await loadFormDetails(formId);
      } catch (error) {
        console.error('Initialization error:', error);
        alert('Error loading form: ' + error.message);
      }
    }

    async function loadFormDetails(formId) {
      try {
        const { data: form, error } = await supabaseClient
          .from('od_forms')
          .select('*')
          .eq('form_id', formId)
          .single();

        if (error) throw error;
        if (!form) throw new Error('Form not found');

        currentForm = form;

        // Load student details
        const { data: student } = await supabaseClient
          .from('users')
          .select('*')
          .eq('id', form.student_id)
          .single();

        // Load event details
        const { data: event } = await supabaseClient
          .from('events')
          .select('*')
          .eq('event_id', form.event_id)
          .single();

        // Load existing subject approvals
        const { data: subjectApprovalRecords } = await supabaseClient
          .from('od_subject_approvals')
          .select('*')
          .eq('form_id', formId);

        renderFormDetails(form, student, event, subjectApprovalRecords || []);
        
        document.getElementById('loading').style.display = 'none';
        document.getElementById('formContent').style.display = 'block';
      } catch (error) {
        console.error('Error loading form:', error);
        alert('Failed to load form details: ' + error.message);
        window.location.href = './od-forms.html';
      }
    }

    function renderFormDetails(form, student, event, subjectApprovalRecords) {
      // Meta
      document.getElementById('formMeta').innerHTML = `
        <div class="meta-item">
          <div class="meta-label">üìÑ Form ID</div>
          <div class="meta-value">${form.form_id}</div>
        </div>
        <div class="meta-item">
          <div class="meta-label">üìÖ Submitted</div>
          <div class="meta-value">${new Date(form.created_at).toLocaleDateString('en-IN')}</div>
        </div>
        <div class="meta-item">
          <div class="meta-label">üè∑Ô∏è Form Type</div>
          <div class="meta-value">${form.form_type === 'participant' ? 'Participant' : 'Volunteer'}</div>
        </div>
        <div class="meta-item">
          <div class="meta-label">üìä Status</div>
          <div class="status-badge status-pending">${form.status}</div>
        </div>
      `;

      // Student Info
      document.getElementById('studentInfo').innerHTML = `
        <div class="info-item">
          <label>üë§ Name</label>
          <value>${form.student_name || student?.full_name || 'N/A'}</value>
        </div>
        <div class="info-item">
          <label>üé´ Roll Number</label>
          <value>${form.roll_number || 'N/A'}</value>
        </div>
        <div class="info-item">
          <label>üìö Course</label>
          <value>${student?.course || form.department || 'N/A'}</value>
        </div>
        <div class="info-item">
          <label>üìñ Year</label>
          <value>${student?.year ? (typeof student.year === 'string' ? student.year : (['I', 'II', 'III', 'IV'][student.year - 1] || student.year)) : (form.year ? (['I', 'II', 'III', 'IV'][form.year - 1] || form.year) : 'N/A')}</value>
        </div>
        <div class="info-item">
          <label>üî§ Division</label>
          <value>Division ${form.division || 'N/A'}</value>
        </div>
      `;

      // Event Info
      document.getElementById('eventInfo').innerHTML = `
        <div class="info-item">
          <label>üìå Event Name</label>
          <value>${event?.event_name || 'N/A'}</value>
        </div>
        <div class="info-item">
          <label>üéØ Event Type</label>
          <value>${event?.event_type || 'N/A'}</value>
        </div>
        <div class="info-item">
          <label>üìÖ Event Date</label>
          <value>${event?.event_date ? new Date(event.event_date).toLocaleDateString('en-IN') : 'N/A'}</value>
        </div>
        <div class="info-item">
          <label>üìç Venue</label>
          <value>${event?.venue || 'N/A'}</value>
        </div>
      `;

      // Event Leader Approval Status
      const leaderStatus = form.approved_by_event_leader 
        ? '<span style="color: #34A853;">‚úÖ Approved</span>'
        : '<span style="color: #FBCF33;">‚è≥ Pending</span>';
      
      document.getElementById('leaderApprovalStatus').innerHTML = `
        <div class="info-grid">
          <div class="info-item">
            <label>Event Leader Status</label>
            <value>${leaderStatus}</value>
          </div>
          <div class="info-item">
            <label>Event Leader Comments</label>
            <value>${form.event_leader_comments || 'No comments'}</value>
          </div>
          <div class="info-item">
            <label>Approved Subjects</label>
            <value>${form.approved_subjects_count || 0}</value>
          </div>
          <div class="info-item">
            <label>Rejected Subjects</label>
            <value>${form.rejected_subjects_count || 0}</value>
          </div>
        </div>
      `;

      // Subjects Table
      let subjects = form.missed_lectures || form.subjects || [];
      
      // Parse if it's a JSON string
      if (typeof subjects === 'string') {
        try {
          subjects = JSON.parse(subjects);
        } catch (e) {
          console.error('Error parsing subjects:', e);
          subjects = [];
        }
      }
      
      // Convert object to array if needed
      if (typeof subjects === 'object' && !Array.isArray(subjects)) {
        subjects = Object.values(subjects);
      }
      
      console.log('========== SUBJECT FILTERING DEBUG ==========');
      console.log('Total subjects from form:', subjects.length);
      console.log('Subject approval records:', subjectApprovalRecords);
      
      // FILTER OUT rejected subjects BEFORE rendering
      subjects = subjects.filter(subject => {
        const approvalRecord = subjectApprovalRecords.find(r => 
          r.subject_name === subject.subject_name && 
          r.subject_date === subject.lecture_date &&
          r.subject_time === subject.lecture_time
        );
        
        // If there's an approval record, check if it was rejected by event leader
        if (approvalRecord) {
          const isRejected = approvalRecord.status === 'rejected_by_leader' || 
                           approvalRecord.rejected_by_event_leader === true;
          console.log(`Subject: ${subject.subject_name}, Status: ${approvalRecord.status}, Rejected: ${isRejected}`);
          return !isRejected; // Keep only non-rejected subjects
        }
        
        // If no approval record, keep the subject (shouldn't happen in partial approval case)
        console.log(`Subject: ${subject.subject_name}, No approval record found`);
        return true;
      });
      
      console.log('Subjects after filtering (rejected ones removed):', subjects.length);
      console.log('Filtered subjects:', subjects.map(s => s.subject_name));
      console.log('=============================================');
      
      // Initialize approvals from existing records or event leader approvals
      subjects.forEach((subject, index) => {
        const subjectId = `subject_${index}`;
        const existingApproval = subjectApprovalRecords.find(r => 
          r.subject_name === subject.subject_name && 
          r.subject_date === subject.lecture_date &&
          r.subject_time === subject.lecture_time
        );

        if (existingApproval) {
          if (existingApproval.faculty_status === 'approved' || existingApproval.approved_by_faculty) {
            subjectApprovals[subjectId] = true;
          } else if (existingApproval.faculty_status === 'rejected' || existingApproval.rejected_by_faculty) {
            subjectApprovals[subjectId] = false;
          } else if (existingApproval.status === 'approved_by_leader' || existingApproval.approved_by_event_leader) {
            // Pre-approve if event leader approved
            subjectApprovals[subjectId] = true;
          } else {
            subjectApprovals[subjectId] = null;
          }
        } else {
          subjectApprovals[subjectId] = null;
        }
      });

      let tableHTML = `
        <thead>
          <tr>
            <th>#</th>
            <th>Subject</th>
            <th>Subject Code</th>
            <th>Faculty</th>
            <th>Date</th>
            <th>Time</th>
            <th>Duration</th>
            <th>Leader Status</th>
            <th>Faculty Action</th>
          </tr>
        </thead>
        <tbody>
      `;

      let displayIndex = 0;
      subjects.forEach((subject, index) => {
        const subjectId = `subject_${index}`;
        const approval = subjectApprovals[subjectId];
        
        const leaderApproval = subjectApprovalRecords.find(r => 
          r.subject_name === subject.subject_name && 
          r.subject_date === subject.lecture_date &&
          r.subject_time === subject.lecture_time
        );
        
        // Subjects are already filtered, so just render all of them
        displayIndex++;
        const rowClass = approval === true ? 'approved' : (approval === false ? 'rejected' : '');
        
        console.log('Rendering subject:', subject.subject_name, 'Leader approval record:', leaderApproval);
        
        const leaderStatusBadge = (leaderApproval?.status === 'approved_by_leader' || leaderApproval?.approved_by_event_leader === true)
          ? '<span style="color: #34A853;">‚úÖ Approved</span>'
          : (leaderApproval?.status === 'rejected_by_leader' || leaderApproval?.rejected_by_event_leader === true)
          ? '<span style="color: #EF4444;">‚ùå Rejected</span>'
          : '<span style="color: #94A3B8;">‚è≥ Pending</span>';

        tableHTML += `
          <tr class="${rowClass}">
            <td>${displayIndex}</td>
            <td><strong>${subject.subject_name}</strong></td>
            <td>${subject.subject_code || 'N/A'}</td>
            <td>${subject.faculty_name}</td>
            <td>${new Date(subject.lecture_date).toLocaleDateString('en-IN')}</td>
            <td>${subject.lecture_time}</td>
            <td>${subject.duration || 60} min</td>
            <td>${leaderStatusBadge}</td>
            <td>
              <div class="subject-actions">
                <button class="btn-subject btn-subject-approve ${approval === true ? 'active' : ''}" 
                        onclick="toggleSubjectApproval('${subjectId}', true)">
                  ‚úì Approve
                </button>
                <button class="btn-subject btn-subject-reject ${approval === false ? 'active' : ''}" 
                        onclick="toggleSubjectApproval('${subjectId}', false)">
                  ‚úï Reject
                </button>
              </div>
            </td>
          </tr>
        `;
      });

      tableHTML += '</tbody>';
      document.getElementById('subjectsTable').innerHTML = tableHTML;

      // Proof Documents
      if (form.proof_documents && form.proof_documents.length > 0) {
        let docsHTML = '<div style="display: flex; flex-wrap: wrap; gap: 1rem;">';
        form.proof_documents.forEach((doc, index) => {
          const url = `https://uhvtmwoihzaaqawimdhm.supabase.co/storage/v1/object/public/od-documents/${doc}`;
          docsHTML += `
            <a href="${url}" target="_blank" class="document-link">
              üìÑ Document ${index + 1}
              <span style="color: #94A3B8; font-size: 0.75rem;">Click to view</span>
            </a>
          `;
        });
        docsHTML += '</div>';
        document.getElementById('proofDocuments').innerHTML = docsHTML;
      } else {
        document.getElementById('proofDocuments').innerHTML = '<p style="color: #64748B;">No proof documents attached</p>';
      }

      updateApprovalSummary();
    }

    function toggleSubjectApproval(subjectId, isApproved) {
      if (subjectApprovals[subjectId] === isApproved) {
        subjectApprovals[subjectId] = null;
      } else {
        subjectApprovals[subjectId] = isApproved;
      }
      
      const row = event.target.closest('tr');
      row.classList.remove('approved', 'rejected');
      if (subjectApprovals[subjectId] === true) row.classList.add('approved');
      if (subjectApprovals[subjectId] === false) row.classList.add('rejected');
      
      const approveBtn = row.querySelector('.btn-subject-approve');
      const rejectBtn = row.querySelector('.btn-subject-reject');
      approveBtn.classList.toggle('active', subjectApprovals[subjectId] === true);
      rejectBtn.classList.toggle('active', subjectApprovals[subjectId] === false);
      
      updateApprovalSummary();
    }

    function updateApprovalSummary() {
      const approved = Object.values(subjectApprovals).filter(v => v === true).length;
      const rejected = Object.values(subjectApprovals).filter(v => v === false).length;
      const pending = Object.values(subjectApprovals).filter(v => v === null).length;
      
      document.getElementById('approvedCount').textContent = approved;
      document.getElementById('rejectedCount').textContent = rejected;
      document.getElementById('pendingCount').textContent = pending;
    }

    function approveAll() {
      Object.keys(subjectApprovals).forEach(key => {
        subjectApprovals[key] = true;
      });
      loadFormDetails(currentForm.form_id);
    }

    function rejectAll() {
      Object.keys(subjectApprovals).forEach(key => {
        subjectApprovals[key] = false;
      });
      loadFormDetails(currentForm.form_id);
    }

    async function submitDecisions() {
      const approved = Object.values(subjectApprovals).filter(v => v === true).length;
      const rejected = Object.values(subjectApprovals).filter(v => v === false).length;
      const pending = Object.values(subjectApprovals).filter(v => v === null).length;
      const comments = document.getElementById('comments').value.trim();

      if (approved === 0 && rejected === 0) {
        alert('‚ö†Ô∏è Please approve or reject at least one subject.');
        return;
      }

      const confirmMsg = `üìä Faculty Approval Summary:\n\n‚úÖ Approved: ${approved}\n‚ùå Rejected: ${rejected}\n‚è≥ Pending: ${pending}\n\n${approved > 0 ? 'Approved subjects will be forwarded to HOD for final review.\n' : ''}${rejected > 0 ? 'Rejected subjects will be marked.\n' : ''}${pending > 0 ? 'Pending subjects will not be processed.\n' : ''}\nContinue?`;

      if (!confirm(confirmMsg)) return;

      try {
        // Update subject approvals
        const subjectApprovalRecords = currentForm.subjects.map((subject, index) => {
          const subjectId = `subject_${index}`;
          const approvalStatus = subjectApprovals[subjectId];
          
          return {
            form_id: currentForm.form_id,
            student_id: currentForm.student_id,
            subject_name: subject.subject_name,
            subject_code: subject.subject_code || '',
            faculty_name: subject.faculty_name,
            subject_date: subject.lecture_date,
            subject_time: subject.lecture_time,
            duration: subject.duration,
            lecture_type: subject.lecture_type,
            faculty_status: approvalStatus === true ? 'approved' : (approvalStatus === false ? 'rejected' : 'pending'),
            faculty_remarks: approvalStatus === false ? comments : null,
            faculty_reviewed_by: currentUser.id,
            faculty_reviewed_at: new Date().toISOString()
          };
        }).filter(record => record.faculty_status !== 'pending');

        if (subjectApprovalRecords.length > 0) {
          const { error: subjectError } = await supabaseClient
            .from('od_subject_approvals')
            .upsert(subjectApprovalRecords, {
              onConflict: 'form_id,subject_name,subject_date,subject_time'
            });

          if (subjectError) throw subjectError;
        }

        // Update main OD form
        const allApproved = approved > 0 && rejected === 0 && pending === 0;
        const allRejected = rejected > 0 && approved === 0;
        const partialApproval = approved > 0 && (rejected > 0 || pending > 0);

        const { error } = await supabaseClient
          .from('od_forms')
          .update({
            approved_by_faculty: allApproved || partialApproval,
            faculty_comments: comments || null,
            faculty_reviewed_by: currentUser.id,
            faculty_reviewed_at: new Date().toISOString(),
            faculty_status: allApproved ? 'approved' : (partialApproval ? 'partially_approved' : 'rejected'),
            status: allApproved ? 'approved_by_faculty' : (partialApproval ? 'partially_approved_by_faculty' : 'rejected_by_faculty')
          })
          .eq('form_id', currentForm.form_id);

        if (error) throw error;

        const successMsg = allApproved 
          ? `‚úÖ All ${approved} subjects approved!\n\nThe form will now be sent to HOD for final review.`
          : partialApproval
          ? `‚úÖ Partial approval completed!\n\n‚úÖ Approved: ${approved} subjects\n‚ùå Rejected: ${rejected} subjects\n\nOnly approved subjects will be forwarded to HOD.`
          : `‚ùå All subjects rejected.\n\nThe student will be notified.`;

        alert(successMsg);
        window.location.href = 'od-forms.html';

      } catch (error) {
        console.error('Error updating form:', error);
        alert('‚ùå Failed to update form: ' + error.message);
      }
    }

    function goBack() {
      window.location.href = 'od-forms.html';
    }

    function logout() {
      if (confirm('Are you sure you want to logout?')) {
        supabaseClient.auth.signOut();
        window.location.href = '../../login.html';
      }
    }

    init();
  </script>
</body>
</html>
